<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YAKA Guest Assistant</title>
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<meta name="theme-color" content="#161616">
  <style>
    :root{
      --yaka-red: #7a1315;
      --yaka-grey: #cececd;
      --yaka-dark: #161616;

      --card: rgba(22,22,22,0.78);
      --card-border: rgba(206,206,205,0.18);
      --text: var(--yaka-grey);
      --muted: rgba(206,206,205,0.75);
      --shadow: 0 18px 45px rgba(0,0,0,0.45);

      --input-bg: rgba(206,206,205,0.08);
      --input-border: rgba(206,206,205,0.22);

      --me-bg: rgba(206,206,205,0.10);
      --me-border: rgba(206,206,205,0.24);

      --bot-bg: rgba(122,19,21,0.12);
      --bot-border: rgba(122,19,21,0.35);
    }

    * { box-sizing: border-box; }

    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: var(--yaka-dark);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(900px 520px at 10% 5%, rgba(122,19,21,0.35), transparent 55%),
        radial-gradient(900px 520px at 90% 15%, rgba(206,206,205,0.14), transparent 55%),
        radial-gradient(700px 420px at 50% 120%, rgba(122,19,21,0.22), transparent 60%);
    }

    .wrap{
      max-width: 920px;
      margin: 0 auto;
      padding: 18px 14px 22px;
    }

    .card{
      border-radius: 22px;
      overflow: hidden;
      border: 1px solid var(--card-border);
      background: linear-gradient(180deg, rgba(22,22,22,0.86), rgba(22,22,22,0.72));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .header{
      padding: 22px 18px 14px;
      text-align: center;
      position: relative;
    }

    .header::after{
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(900px 250px at 50% 0%, rgba(122,19,21,0.55), transparent 60%),
        radial-gradient(900px 250px at 50% 60%, rgba(206,206,205,0.10), transparent 60%);
      opacity: 0.9;
    }

    .brand{
      position: relative;
      z-index: 1;
      display: grid;
      place-items: center;
      gap: 10px;
    }

    .brand img{
      height: 200px;
      width: auto;
      display: block;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,0.55));
    }

    .brand .tag{
      margin-top: -6px;
      font-size: 14px;
      color: rgba(206,206,205,0.82);
      letter-spacing: 0.8px;
      text-transform: uppercase;
    }

    /* language row */
    .lang-row{
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .lang-row label{
      font-size: 12px;
      color: rgba(206,206,205,0.80);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* FIX: dropdown visibility for non-selected options */
    .lang-row select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(206,206,205,0.22);
      background: rgba(0,0,0,0.18);
      color: var(--yaka-grey);
      outline: none;
      min-width: 260px;

      /* improve cross-browser rendering */
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;

      /* helps some browsers respect dark UI while we force option colours */
      color-scheme: dark;
    }

    /* This is the key fix: options must be readable in the opened list */
    .lang-row select option{
      background: #f2f2f2;   /* light background so the text shows */
      color: #111111;        /* dark text */
    }

    /* optional: focus style */
    .lang-row select:focus{
      border-color: rgba(122,19,21,0.70);
      box-shadow: 0 0 0 3px rgba(122,19,21,0.25);
    }

    .sub{
      padding: 12px 18px;
      font-size: 13px;
      color: var(--muted);
      border-top: 1px solid rgba(206,206,205,0.10);
      border-bottom: 1px solid rgba(206,206,205,0.10);
      background: rgba(0,0,0,0.08);
    }

    .status{
      padding: 10px 18px;
      font-size: 12px;
      color: var(--muted);
      border-bottom: 1px solid rgba(206,206,205,0.10);
      background: rgba(0,0,0,0.10);
    }

    .pill{
      display: inline-block;
      padding: 5px 10px;
      border-radius: 999px;
      margin-right: 8px;
      border: 1px solid rgba(206,206,205,0.22);
      background: rgba(206,206,205,0.08);
      color: rgba(206,206,205,0.92);
    }

    .chat{
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 60vh;
      overflow-y: auto;
      background:
        radial-gradient(1000px 520px at 25% 0%, rgba(122,19,21,0.16), transparent 60%),
        radial-gradient(900px 520px at 90% 10%, rgba(206,206,205,0.08), transparent 55%),
        rgba(0,0,0,0.06);
    }

    .bubble{
      padding: 12px 14px;
      border-radius: 16px;
      max-width: 92%;
      line-height: 1.45;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid rgba(206,206,205,0.10);
      box-shadow: 0 10px 25px rgba(0,0,0,0.20);
    }

    .me{
      align-self: flex-end;
      background: var(--me-bg);
      border-color: var(--me-border);
    }

    .bot{
      align-self: flex-start;
      background: var(--bot-bg);
      border-color: var(--bot-border);
    }

    .bubble a{
      color: var(--yaka-grey);
      text-decoration: underline;
      text-underline-offset: 3px;
      word-break: break-word;
    }

    .meta{
      font-size: 11px;
      color: rgba(206,206,205,0.68);
      margin-top: 8px;
    }

    .input-area{
      padding: 14px 18px;
      border-top: 1px solid rgba(206,206,205,0.10);
      background: rgba(0,0,0,0.10);
    }

    .row{
      display:flex;
      gap: 8px;
      align-items: center;
    }

    #msg{
      flex:1;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(206,206,205,0.22);
      font-size: 16px;
      outline: none;
      background: rgba(206,206,205,0.08);
      color: var(--yaka-grey);
    }

    #msg::placeholder{
      color: rgba(206,206,205,0.55);
    }

    #msg:focus{
      border-color: rgba(122,19,21,0.70);
      box-shadow: 0 0 0 3px rgba(122,19,21,0.25);
    }

    button{
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      line-height: 1;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .06s ease, opacity .15s ease, box-shadow .15s ease;
    }

    button:active{ transform: translateY(1px); }

    .btn{
      background: var(--yaka-red);
      color: var(--yaka-grey);
      box-shadow: 0 10px 20px rgba(122,19,21,0.25);
      border: 1px solid rgba(206,206,205,0.14);
    }

    .btn.secondary{
      background: rgba(206,206,205,0.08);
      color: var(--yaka-grey);
      border: 1px solid rgba(206,206,205,0.22);
      box-shadow: none;
    }

    .btn:hover{ opacity: 0.92; }

    .btn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }

    .hint{
      font-size: 12px;
      margin-top: 8px;
      color: rgba(206,206,205,0.70);
    }

    .small-btn{
      padding: 10px 12px;
      font-size: 14px;
      margin-right: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="header">
        <div class="brand">
          <img src="/logo.png" alt="YAKA Residences Logo" />
          <div class="tag" id="tagText">Guest Assistant</div>

          <div class="lang-row">
            <label>
              <span id="langLabel">Language</span>
              <select id="langSelect" aria-label="Select language">
                <option value="en">English</option>
                <option value="si">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω (Sinhala)</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>

                <option value="es">Espa√±ol (Spanish)</option>
                <option value="ru">–†—É—Å—Å–∫–∏–π (Russian)</option>
                <option value="it">Italiano (Italian)</option>
                <option value="zh">‰∏≠Êñá (Mandarin Chinese)</option>
                <option value="de">Deutsch (German)</option>
                <option value="pl">Polski (Polish)</option>
                <option value="fr">Fran√ßais (French)</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                <option value="pt">Portugu√™s (Portuguese)</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (Arabic)</option>
              </select>
            </label>
          </div>
        </div>
      </div>

      <div class="sub" id="subText">
        Ask questions about Wi-Fi, check-in/out, house rules, and nearby places.
      </div>

      <div class="status">
        <span class="pill" id="aptPill">Apartment: (not set)</span>
        <span class="pill" id="apiPill">API: checking‚Ä¶</span>
        <span class="pill" id="micPill">Mic: ready</span>
      </div>

      <div class="chat" id="chat"></div>

      <div class="input-area">
        <div class="row">
          <input id="msg" placeholder="Type or speak your question‚Ä¶" autocomplete="off" />
          <button class="btn secondary" id="micBtn" type="button" title="Voice question" aria-label="Voice question">üéôÔ∏è</button>
          <button class="btn" id="sendBtn" type="button">Send</button>
        </div>
        <div class="hint" id="hintText">
          Tip: Tap üéôÔ∏è to record, tap again to stop &amp; send. The bot can reply in your language and you can play replies aloud.
        </div>
      </div>

    </div>
  </div>

<script>
  const chatEl  = document.getElementById('chat');
  const msgEl   = document.getElementById('msg');
  const sendBtn = document.getElementById('sendBtn');
  const micBtn  = document.getElementById('micBtn');
  const aptPill = document.getElementById('aptPill');
  const apiPill = document.getElementById('apiPill');
  const micPill = document.getElementById('micPill');

  const tagText = document.getElementById('tagText');
  const subText = document.getElementById('subText');
  const hintText = document.getElementById('hintText');
  const langSelect = document.getElementById('langSelect');
  const langLabel = document.getElementById('langLabel');

  const params = new URLSearchParams(window.location.search);
  const apt = (params.get('apt') || '').trim();
  aptPill.textContent = apt ? `Apartment: ${apt}` : 'Apartment: (not set)';

  // ----------------------------
  // Language (multilingual UI)
  // ----------------------------
  const I18N = {
    en: {
      langLabel: "Language",
      tag: "Guest Assistant",
      sub: "Ask questions about Wi-Fi, check-in/out, house rules, and nearby places.",
      aptPrefix: "Apartment",
      apiChecking: "API: checking‚Ä¶",
      apiOk: "API: OK",
      apiNotReady: "API: not ready",
      apiOffline: "API: offline",
      micReady: "Mic: ready",
      micUnsupported: "Mic: unsupported",
      micNeedsHttps: "Mic: needs HTTPS",
      micRecording: "Mic: recording‚Ä¶",
      micTranscribing: "Mic: transcribing‚Ä¶",
      micError: "Mic: error",
      placeholder: "Type or speak your question‚Ä¶",
      send: "Send",
      tip: "Tip: Tap üéôÔ∏è to record, tap again to stop & send. You can type or speak in your selected language. Replies can be read aloud.",
      greet: "Hi! Ask me anything about your stay ‚Äî Wi-Fi, check-in/out, house rules, and local tips.",
      missingApt: "This page needs an apartment code. Example: ?apt=YAKA01",
      missingAptLong: "This link is missing an apartment code. Please scan the apartment QR code or open with ?apt=YAKA01.",
      speak: "üîä Speak",
      stop: "‚èπ Stop",
      generating: "Generating‚Ä¶",
      ttsFail: "Could not play voice.",
      recNotSupported: "Voice recording is not supported on this browser. Please type your question instead.",
      httpsRequired: "Microphone needs HTTPS on mobiles. Use your Azure HTTPS URL (not HTTP).",
      sttFail: "STT failed. Please try again or type your question.",
      langUpdated: "Language updated. You can now type or speak in this language."
    },
    si: {
      langLabel: "‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä",
      tag: "‡∂Ö‡∂∏‡∑î‡∂≠‡∑ä‡∂≠‡∂±‡∑ä ‡∑É‡∑Ñ‡∑è‡∂∫‡∂ö‡∂∫",
      sub: "Wi-Fi, check-in/out, house rules ‡∑É‡∑Ñ ‡∂Ö‡∑Ä‡∂ß ‡∑É‡∑ä‡∂Æ‡∑è‡∂± ‡∂ú‡∑ê‡∂± ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂± ‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂±.",
      aptPrefix: "Apartment",
      apiChecking: "API: ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä‚Ä¶",
      apiOk: "API: OK",
      apiNotReady: "API: ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä ‡∂±‡∑ê‡∑Ñ‡∑ê",
      apiOffline: "API: offline",
      micReady: "Mic: ready",
      micUnsupported: "Mic: unsupported",
      micNeedsHttps: "Mic: HTTPS ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í",
      micRecording: "Mic: record ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä‚Ä¶",
      micTranscribing: "Mic: ‡∂Ω‡∑í‡∂∫‡∂∏‡∑í‡∂±‡∑ä‚Ä¶",
      micError: "Mic: error",
      placeholder: "Type ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∑Ñ‡∑ù ‡∂ö‡∂≠‡∑è ‡∂ö‡∂ª‡∂Ω‡∑è ‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂±‚Ä¶",
      send: "‡∂∫‡∑Ä‡∂±‡∑ä‡∂±",
      tip: "‡∂â‡∂ü‡∑í‡∂∫: üéôÔ∏è ‡∂î‡∂∂‡∑è record ‡∂ö‡∂ª‡∂±‡∑ä‡∂±, ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂î‡∂∂‡∂Ω‡∑è stop ‡∂ö‡∂ª‡∂Ω‡∑è ‡∂∫‡∑Ä‡∂±‡∑ä‡∂±. ‡∂î‡∂∂‡∑ö ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∂≠‡∑ä ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∑ô‡∂±‡∑ä type ‡∑Ñ‡∑ù ‡∂ö‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∑Å‡∂∂‡∑ä‡∂Ø‡∂∫‡∑ô‡∂±‡∑ä ‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂±‡∂≠‡∑ä ‡∂¥‡∑î‡∑Ö‡∑î‡∑Ä‡∂±‡∑ä.",
      greet: "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! ‡∂î‡∂∂‡∑ö ‡∂±‡∑Ä‡∑è‡∂≠‡∑ê‡∂±‡∑ä ‡∂ú‡∑ê‡∂± ‡∂ï‡∂±‡∑ë‡∂∏ ‡∂Ø‡∑ô‡∂∫‡∂ö‡∑ä ‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂± ‚Äî Wi-Fi, check-in/out, house rules, ‡∑É‡∑Ñ local tips.",
      missingApt: "‡∂∏‡∑ô‡∂∏ ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä‡∂ß apartment code ‡∂ë‡∂ö ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í. ‡∂ã‡∂Ø‡∑è: ?apt=YAKA01",
      missingAptLong: "‡∂∏‡∑ô‡∂∏ ‡∂Ω‡∑í‡∂±‡∑ä‡∂ö‡∑ä ‡∂ë‡∂ö‡∂ß apartment code ‡∂ë‡∂ö ‡∂±‡∑ê‡∑Ñ‡∑ê. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª apartment QR code ‡∂ë‡∂ö scan ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∑Ñ‡∑ù ?apt=YAKA01 ‡∑É‡∂∏‡∂ü ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
      speak: "üîä ‡∂ö‡∂Æ‡∂±‡∂∫",
      stop: "‚èπ ‡∂±‡∑Ä‡∂≠‡∑ä‡∑Ä‡∂±‡∑ä‡∂±",
      generating: "‡∂≠‡∑ê‡∂±‡∑ô‡∂±‡∑Ä‡∑è‚Ä¶",
      ttsFail: "‡∑Å‡∂∂‡∑ä‡∂Ø‡∂∫ play ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂∂‡∑ê‡∑Ñ‡∑ê.",
      recNotSupported: "‡∂∏‡∑ô‡∂∏ browser ‡∂ë‡∂ö‡∑ö voice recording support ‡∂±‡∑ê‡∑Ñ‡∑ê. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª type ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
      httpsRequired: "‡∂∏‡∑ú‡∂∂‡∂∫‡∑í‡∂Ω‡∑ä ‡∑Ä‡∂Ω microphone ‡∑É‡∂≥‡∑Ñ‡∑è HTTPS ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í. Azure HTTPS URL ‡∂ë‡∂ö ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
      sttFail: "Voice to text ‡∂Ö‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í. ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∑Ñ‡∑ù type ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
      langUpdated: "‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∂ö‡∑Ö‡∑è. ‡∂Ø‡∑ê‡∂±‡∑ä ‡∂∏‡∑ö ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∑ô‡∂±‡∑ä type ‡∑Ñ‡∑ù ‡∂ö‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±."
    },
    ta: {
      langLabel: "‡ÆÆ‡Øä‡Æ¥‡Æø",
      tag: "‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ®‡Øç‡Æ§‡Æø‡Æ©‡Æ∞‡Øç ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç",
      sub: "Wi-Fi, check-in/out, house rules ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ∞‡ØÅ‡Æï‡Æø‡Æ≤‡ØÅ‡Æ≥‡Øç‡Æ≥ ‡Æá‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ™‡Æ±‡Øç‡Æ±‡Æø ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.",
      aptPrefix: "Apartment",
      apiChecking: "API: ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ‚Ä¶",
      apiOk: "API: OK",
      apiNotReady: "API: ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ≤‡Øç‡Æ≤‡Øà",
      apiOffline: "API: offline",
      micReady: "Mic: ready",
      micUnsupported: "Mic: unsupported",
      micNeedsHttps: "Mic: HTTPS ‡Æ§‡Øá‡Æµ‡Øà",
      micRecording: "Mic: ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ‚Ä¶",
      micTranscribing: "Mic: ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ‚Ä¶",
      micError: "Mic: error",
      placeholder: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Øá‡Æ≥‡Øç‡Æµ‡Æø‡ÆØ‡Øà type ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Øá‡Æö‡Æµ‡ØÅ‡ÆÆ‡Øç‚Ä¶",
      send: "Send",
      tip: "‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ: üéôÔ∏è ‡Æê ‡Æ§‡Æü‡Øç‡Æü‡Æø‡Æ™‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç; ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Æü‡Øç‡Æü‡Æø ‡Æ®‡Æø‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æø ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æµ‡ØÅ‡ÆÆ‡Øç. ‡Æ®‡ØÄ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§ ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Æø‡Æ≤‡Øç type/‡Æ™‡Øá‡Æö‡Æ≤‡Ææ‡ÆÆ‡Øç. ‡Æ™‡Æ§‡Æø‡Æ≤‡Øà ‡Æí‡Æ≤‡Æø‡ÆØ‡Ææ‡Æï‡Æï‡Øç ‡Æï‡Øá‡Æü‡Øç‡Æï‡Æ≤‡Ææ‡ÆÆ‡Øç.",
      greet: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Æô‡Øç‡Æï‡ØÅ‡ÆÆ‡Æø‡Æü‡ÆÆ‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡Æ§‡Øç‡Æ§‡ØÅ ‡Æé‡Æ§‡Øà‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡Æï‡Øá‡Æ≥‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‚Äî Wi-Fi, check-in/out, house rules, ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡ØÇ‡Æ∞‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç.",
      missingApt: "‡Æá‡Æ®‡Øç‡Æ§ ‡Æ™‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ apartment code ‡Æ§‡Øá‡Æµ‡Øà. ‡Æâ‡Æ§‡Ææ‡Æ∞‡Æ£‡ÆÆ‡Øç: ?apt=YAKA01",
      missingAptLong: "‡Æá‡Æ®‡Øç‡Æ§ ‡Æ≤‡Æø‡Æô‡Øç‡Æï‡Æø‡Æ≤‡Øç apartment code ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà. QR code ‡Æê scan ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ?apt=YAKA01 ‡Æâ‡Æü‡Æ©‡Øç ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
      speak: "üîä Speak",
      stop: "‚èπ Stop",
      generating: "‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ‚Ä¶",
      ttsFail: "‡Æí‡Æ≤‡Æø‡ÆØ‡Øà ‡Æá‡ÆØ‡Æï‡Øç‡Æï ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà.",
      recNotSupported: "‡Æá‡Æ®‡Øç‡Æ§ browser ‡Æá‡Æ≤‡Øç voice recording ‡ÆÜ‡Æ§‡Æ∞‡Æµ‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà. ‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ type ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.",
      httpsRequired: "‡ÆÆ‡Øä‡Æ™‡Øà‡Æ≤‡Æø‡Æ≤‡Øç microphone ‡Æï‡Øç‡Æï‡ØÅ HTTPS ‡Æ§‡Øá‡Æµ‡Øà. Azure HTTPS URL ‡Æê ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç.",
      sttFail: "STT ‡Æ§‡Øã‡Æ≤‡Øç‡Æµ‡Æø. ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ type ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.",
      langUpdated: "‡ÆÆ‡Øä‡Æ¥‡Æø ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ. ‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ ‡Æá‡Æ®‡Øç‡Æ§ ‡ÆÆ‡Øä‡Æ¥‡Æø‡ÆØ‡Æø‡Æ≤‡Øç type/‡Æ™‡Øá‡Æö‡Æ≤‡Ææ‡ÆÆ‡Øç."
    },

    // New UI languages (kept simple & consistent)
    es: { langLabel:"Idioma", tag:"Asistente de Hu√©spedes", sub:"Pregunta sobre Wi-Fi, check-in/out, normas de la casa y lugares cercanos.", aptPrefix:"Apartamento",
      apiChecking:"API: comprobando‚Ä¶", apiOk:"API: OK", apiNotReady:"API: no lista", apiOffline:"API: sin conexi√≥n",
      micReady:"Mic: listo", micUnsupported:"Mic: no compatible", micNeedsHttps:"Mic: requiere HTTPS", micRecording:"Mic: grabando‚Ä¶", micTranscribing:"Mic: transcribiendo‚Ä¶", micError:"Mic: error",
      placeholder:"Escribe o habla tu pregunta‚Ä¶", send:"Enviar",
      tip:"Consejo: toca üéôÔ∏è para grabar; toca de nuevo para parar y enviar. Puedes escribir o hablar en tu idioma. Las respuestas se pueden leer en voz alta.",
      greet:"¬°Hola! Preg√∫ntame lo que quieras sobre tu estancia ‚Äî Wi-Fi, check-in/out, normas y recomendaciones locales.",
      missingApt:"Esta p√°gina necesita un c√≥digo de apartamento. Ejemplo: ?apt=YAKA01",
      missingAptLong:"Este enlace no tiene c√≥digo de apartamento. Escanea el QR del apartamento o abre con ?apt=YAKA01.",
      speak:"üîä Hablar", stop:"‚èπ Parar", generating:"Generando‚Ä¶", ttsFail:"No se pudo reproducir la voz.",
      recNotSupported:"La grabaci√≥n de voz no es compatible en este navegador. Escribe tu pregunta.",
      httpsRequired:"El micr√≥fono requiere HTTPS en m√≥viles. Usa tu URL HTTPS (no HTTP).",
      sttFail:"Fall√≥ voz a texto. Int√©ntalo de nuevo o escribe.",
      langUpdated:"Idioma actualizado. Ahora puedes escribir o hablar en este idioma."
    },

    ru: { langLabel:"–Ø–∑—ã–∫", tag:"–ü–æ–º–æ—â–Ω–∏–∫ –≥–æ—Å—Ç—è", sub:"–°–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–æ Wi-Fi, –∑–∞–µ–∑–¥/–≤—ã–µ–∑–¥, –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–º–∞ –∏ –º–µ—Å—Ç–∞ —Ä—è–¥–æ–º.", aptPrefix:"–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã",
      apiChecking:"API: –ø—Ä–æ–≤–µ—Ä–∫–∞‚Ä¶", apiOk:"API: OK", apiNotReady:"API: –Ω–µ –≥–æ—Ç–æ–≤–æ", apiOffline:"API: –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ",
      micReady:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –≥–æ—Ç–æ–≤", micUnsupported:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", micNeedsHttps:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –Ω—É–∂–µ–Ω HTTPS", micRecording:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –∑–∞–ø–∏—Å—å‚Ä¶", micTranscribing:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω: —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ‚Ä¶", micError:"–ú–∏–∫—Ä–æ—Ñ–æ–Ω: –æ—à–∏–±–∫–∞",
      placeholder:"–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ —Å–∫–∞–∂–∏—Ç–µ –≤–æ–ø—Ä–æ—Å‚Ä¶", send:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å",
      tip:"–°–æ–≤–µ—Ç: –Ω–∞–∂–º–∏—Ç–µ üéôÔ∏è –¥–ª—è –∑–∞–ø–∏—Å–∏; –Ω–∞–∂–º–∏—Ç–µ –µ—â—ë —Ä–∞–∑, —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å. –ú–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ. –û—Ç–≤–µ—Ç –º–æ–∂–Ω–æ –æ–∑–≤—É—á–∏—Ç—å.",
      greet:"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –°–ø—Ä–æ—Å–∏—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ –æ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–∏ ‚Äî Wi-Fi, –∑–∞–µ–∑–¥/–≤—ã–µ–∑–¥, –ø—Ä–∞–≤–∏–ª–∞ –∏ –º–µ—Å—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.",
      missingApt:"–ù—É–∂–µ–Ω –∫–æ–¥ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞. –ü—Ä–∏–º–µ—Ä: ?apt=YAKA01",
      missingAptLong:"–í —Å—Å—ã–ª–∫–µ –Ω–µ—Ç –∫–æ–¥–∞ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å ?apt=YAKA01.",
      speak:"üîä –û–∑–≤—É—á–∏—Ç—å", stop:"‚èπ –°—Ç–æ–ø", generating:"–ì–µ–Ω–µ—Ä–∞—Ü–∏—è‚Ä¶", ttsFail:"–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≥–æ–ª–æ—Å.",
      recNotSupported:"–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å.",
      httpsRequired:"–î–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –Ω—É–∂–µ–Ω HTTPS. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS URL.",
      sttFail:"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç.",
      langUpdated:"–Ø–∑—ã–∫ –æ–±–Ω–æ–≤–ª—ë–Ω. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∏–ª–∏ –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ —ç—Ç–æ–º —è–∑—ã–∫–µ."
    },

    it: { langLabel:"Lingua", tag:"Assistente Ospiti", sub:"Chiedi informazioni su Wi-Fi, check-in/out, regole della casa e luoghi vicini.", aptPrefix:"Appartamento",
      apiChecking:"API: controllo‚Ä¶", apiOk:"API: OK", apiNotReady:"API: non pronta", apiOffline:"API: offline",
      micReady:"Mic: pronto", micUnsupported:"Mic: non supportato", micNeedsHttps:"Mic: serve HTTPS", micRecording:"Mic: registrazione‚Ä¶", micTranscribing:"Mic: trascrizione‚Ä¶", micError:"Mic: errore",
      placeholder:"Scrivi o parla la tua domanda‚Ä¶", send:"Invia",
      tip:"Suggerimento: tocca üéôÔ∏è per registrare; tocca di nuovo per fermare e inviare. Puoi scrivere o parlare nella lingua selezionata. Le risposte possono essere lette ad alta voce.",
      greet:"Ciao! Chiedimi qualsiasi cosa sul tuo soggiorno ‚Äî Wi-Fi, check-in/out, regole e consigli locali.",
      missingApt:"Questa pagina richiede un codice appartamento. Esempio: ?apt=YAKA01",
      missingAptLong:"Questo link non include un codice appartamento. Scansiona il QR dell‚Äôappartamento o apri con ?apt=YAKA01.",
      speak:"üîä Voce", stop:"‚èπ Stop", generating:"Generazione‚Ä¶", ttsFail:"Impossibile riprodurre la voce.",
      recNotSupported:"La registrazione vocale non √® supportata in questo browser. Scrivi la domanda.",
      httpsRequired:"Il microfono richiede HTTPS sui telefoni. Usa l‚ÄôURL HTTPS.",
      sttFail:"Riconoscimento vocale fallito. Riprova o scrivi.",
      langUpdated:"Lingua aggiornata. Ora puoi scrivere o parlare in questa lingua."
    },

    zh: { langLabel:"ËØ≠Ë®Ä", tag:"‰ΩèÂÆ¢Âä©Êâã", sub:"ÂèØËØ¢ÈóÆ Wi-Fi„ÄÅÂÖ•‰Ωè/ÈÄÄÊàø„ÄÅÊàøÂ±ãËßÑÂàôÂèäÈôÑËøëÂú∞ÁÇπ„ÄÇ", aptPrefix:"ÂÖ¨ÂØì",
      apiChecking:"APIÔºöÊ£ÄÊü•‰∏≠‚Ä¶", apiOk:"APIÔºöÊ≠£Â∏∏", apiNotReady:"APIÔºöÊú™Â∞±Áª™", apiOffline:"APIÔºöÁ¶ªÁ∫ø",
      micReady:"È∫¶ÂÖãÈ£éÔºöÂ∞±Áª™", micUnsupported:"È∫¶ÂÖãÈ£éÔºö‰∏çÊîØÊåÅ", micNeedsHttps:"È∫¶ÂÖãÈ£éÔºöÈúÄË¶Å HTTPS", micRecording:"È∫¶ÂÖãÈ£éÔºöÂΩïÈü≥‰∏≠‚Ä¶", micTranscribing:"È∫¶ÂÖãÈ£éÔºöËΩ¨ÂÜô‰∏≠‚Ä¶", micError:"È∫¶ÂÖãÈ£éÔºöÈîôËØØ",
      placeholder:"ËØ∑ËæìÂÖ•ÊàñËØ¥Âá∫ÊÇ®ÁöÑÈóÆÈ¢ò‚Ä¶", send:"ÂèëÈÄÅ",
      tip:"ÊèêÁ§∫ÔºöÁÇπÊåâ üéôÔ∏è ÂºÄÂßãÂΩïÈü≥ÔºõÂÜçÊ¨°ÁÇπÊåâÂÅúÊ≠¢Âπ∂ÂèëÈÄÅ„ÄÇÂèØÁî®ÊâÄÈÄâËØ≠Ë®ÄËæìÂÖ•ÊàñËØ≠Èü≥„ÄÇÂõûÂ§çÂèØÊúóËØª„ÄÇ",
      greet:"ÊÇ®Â•ΩÔºÅÊ¨¢ËøéÊèêÈóÆÂÖ•‰ΩèÁõ∏ÂÖ≥‰ªª‰ΩïÂÜÖÂÆπ ‚Äî Wi-Fi„ÄÅÂÖ•‰Ωè/ÈÄÄÊàø„ÄÅËßÑÂàôÂèäÊú¨Âú∞Âª∫ËÆÆ„ÄÇ",
      missingApt:"Ê≠§È°µÈù¢ÈúÄË¶ÅÂÖ¨ÂØì‰ª£Á†ÅÔºå‰æãÂ¶ÇÔºö?apt=YAKA01",
      missingAptLong:"Ê≠§ÈìæÊé•Áº∫Â∞ëÂÖ¨ÂØì‰ª£Á†Å„ÄÇËØ∑Êâ´ÊèèÂÖ¨ÂØì‰∫åÁª¥Á†ÅÔºåÊàñ‰ΩøÁî® ?apt=YAKA01 ÊâìÂºÄ„ÄÇ",
      speak:"üîä ÊúóËØª", stop:"‚èπ ÂÅúÊ≠¢", generating:"ÁîüÊàê‰∏≠‚Ä¶", ttsFail:"Êó†Ê≥ïÊí≠ÊîæËØ≠Èü≥„ÄÇ",
      recNotSupported:"ËØ•ÊµèËßàÂô®‰∏çÊîØÊåÅÂΩïÈü≥ÔºåËØ∑Êîπ‰∏∫ËæìÂÖ•„ÄÇ",
      httpsRequired:"ÊâãÊú∫Á´ØÈ∫¶ÂÖãÈ£éÈúÄË¶Å HTTPSÔºåËØ∑‰ΩøÁî® HTTPS Âú∞ÂùÄ„ÄÇ",
      sttFail:"ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÊàñËæìÂÖ•„ÄÇ",
      langUpdated:"ËØ≠Ë®ÄÂ∑≤Êõ¥Êñ∞„ÄÇÁé∞Âú®ÂèØÁî®ËØ•ËØ≠Ë®ÄËæìÂÖ•ÊàñËØ≠Èü≥„ÄÇ"
    },

    de: { langLabel:"Sprache", tag:"G√§steassistent", sub:"Fragen Sie nach Wi-Fi, Check-in/out, Hausregeln und Orten in der N√§he.", aptPrefix:"Apartment",
      apiChecking:"API: pr√ºfe‚Ä¶", apiOk:"API: OK", apiNotReady:"API: nicht bereit", apiOffline:"API: offline",
      micReady:"Mic: bereit", micUnsupported:"Mic: nicht unterst√ºtzt", micNeedsHttps:"Mic: braucht HTTPS", micRecording:"Mic: Aufnahme‚Ä¶", micTranscribing:"Mic: Transkription‚Ä¶", micError:"Mic: Fehler",
      placeholder:"Tippen oder sprechen Sie Ihre Frage‚Ä¶", send:"Senden",
      tip:"Tipp: üéôÔ∏è zum Aufnehmen tippen; erneut tippen zum Stoppen & Senden. Sie k√∂nnen tippen oder sprechen. Antworten k√∂nnen vorgelesen werden.",
      greet:"Hallo! Fragen Sie alles zu Ihrem Aufenthalt ‚Äî Wi-Fi, Check-in/out, Regeln und lokale Tipps.",
      missingApt:"Diese Seite ben√∂tigt einen Apartment-Code. Beispiel: ?apt=YAKA01",
      missingAptLong:"Dieser Link enth√§lt keinen Apartment-Code. Bitte QR scannen oder mit ?apt=YAKA01 √∂ffnen.",
      speak:"üîä Vorlesen", stop:"‚èπ Stopp", generating:"Erstelle‚Ä¶", ttsFail:"Sprachausgabe nicht m√∂glich.",
      recNotSupported:"Sprachaufnahme wird in diesem Browser nicht unterst√ºtzt. Bitte tippen.",
      httpsRequired:"Mikrofon ben√∂tigt HTTPS auf Mobilger√§ten. Bitte HTTPS-URL verwenden.",
      sttFail:"Spracherkennung fehlgeschlagen. Bitte erneut versuchen oder tippen.",
      langUpdated:"Sprache aktualisiert. Sie k√∂nnen jetzt in dieser Sprache tippen oder sprechen."
    },

    pl: { langLabel:"Jƒôzyk", tag:"Asystent Go≈õcia", sub:"Zapytaj o Wi-Fi, zameldowanie/wymeldowanie, zasady domu i miejsca w pobli≈ºu.", aptPrefix:"Apartament",
      apiChecking:"API: sprawdzanie‚Ä¶", apiOk:"API: OK", apiNotReady:"API: niegotowe", apiOffline:"API: offline",
      micReady:"Mic: gotowy", micUnsupported:"Mic: brak wsparcia", micNeedsHttps:"Mic: wymaga HTTPS", micRecording:"Mic: nagrywanie‚Ä¶", micTranscribing:"Mic: transkrypcja‚Ä¶", micError:"Mic: b≈ÇƒÖd",
      placeholder:"Wpisz lub powiedz pytanie‚Ä¶", send:"Wy≈õlij",
      tip:"Wskaz√≥wka: dotknij üéôÔ∏è aby nagraƒá; dotknij ponownie, aby zatrzymaƒá i wys≈Çaƒá. Mo≈ºesz pisaƒá lub m√≥wiƒá w wybranym jƒôzyku. Odpowiedzi mo≈ºna odczytaƒá na g≈Ços.",
      greet:"Cze≈õƒá! Zapytaj o wszystko dotyczƒÖce pobytu ‚Äî Wi-Fi, zameldowanie/wymeldowanie, zasady i lokalne wskaz√≥wki.",
      missingApt:"Ta strona wymaga kodu apartamentu. Przyk≈Çad: ?apt=YAKA01",
      missingAptLong:"W tym linku brakuje kodu apartamentu. Zeskanuj QR lub otw√≥rz z ?apt=YAKA01.",
      speak:"üîä Odczytaj", stop:"‚èπ Stop", generating:"Generowanie‚Ä¶", ttsFail:"Nie mo≈ºna odtworzyƒá g≈Çosu.",
      recNotSupported:"Nagrywanie g≈Çosu nie jest wspierane w tej przeglƒÖdarce. Wpisz pytanie.",
      httpsRequired:"Mikrofon na telefonach wymaga HTTPS. U≈ºyj adresu HTTPS.",
      sttFail:"Rozpoznawanie mowy nie powiod≈Ço siƒô. Spr√≥buj ponownie lub wpisz.",
      langUpdated:"Jƒôzyk zaktualizowany. Mo≈ºesz teraz pisaeste≈õmy pisaƒá lub m√≥wiƒá w tym jƒôzyku."
    },

    fr: { langLabel:"Langue", tag:"Assistant Invit√©", sub:"Posez des questions sur le Wi-Fi, l‚Äôarriv√©e/d√©part, les r√®gles et les lieux √† proximit√©.", aptPrefix:"Appartement",
      apiChecking:"API : v√©rification‚Ä¶", apiOk:"API : OK", apiNotReady:"API : non pr√™te", apiOffline:"API : hors ligne",
      micReady:"Micro : pr√™t", micUnsupported:"Micro : non pris en charge", micNeedsHttps:"Micro : HTTPS requis", micRecording:"Micro : enregistrement‚Ä¶", micTranscribing:"Micro : transcription‚Ä¶", micError:"Micro : erreur",
      placeholder:"Tapez ou dites votre question‚Ä¶", send:"Envoyer",
      tip:"Astuce : touchez üéôÔ∏è pour enregistrer ; retouchez pour arr√™ter et envoyer. Vous pouvez taper ou parler. Les r√©ponses peuvent √™tre lues √† voix haute.",
      greet:"Bonjour ! Demandez tout sur votre s√©jour ‚Äî Wi-Fi, arriv√©e/d√©part, r√®gles et conseils locaux.",
      missingApt:"Cette page n√©cessite un code d‚Äôappartement. Exemple : ?apt=YAKA01",
      missingAptLong:"Ce lien n‚Äôa pas de code d‚Äôappartement. Scannez le QR ou ouvrez avec ?apt=YAKA01.",
      speak:"üîä Lire", stop:"‚èπ Stop", generating:"G√©n√©ration‚Ä¶", ttsFail:"Impossible de lire la voix.",
      recNotSupported:"L‚Äôenregistrement vocal n‚Äôest pas pris en charge sur ce navigateur. Veuillez taper votre question.",
      httpsRequired:"Le micro n√©cessite HTTPS sur mobile. Utilisez l‚ÄôURL HTTPS.",
      sttFail:"√âchec de la reconnaissance vocale. R√©essayez ou tapez.",
      langUpdated:"Langue mise √† jour. Vous pouvez maintenant taper ou parler dans cette langue."
    },

    hi: { langLabel:"‡§≠‡§æ‡§∑‡§æ", tag:"‡§Ö‡§§‡§ø‡§•‡§ø ‡§∏‡§π‡§æ‡§Ø‡§ï", sub:"Wi-Fi, ‡§ö‡•á‡§ï-‡§á‡§®/‡§Ü‡§â‡§ü, ‡§ò‡§∞ ‡§ï‡•á ‡§®‡§ø‡§Ø‡§Æ ‡§î‡§∞ ‡§™‡§æ‡§∏ ‡§ï‡•á ‡§∏‡•ç‡§•‡§æ‡§®‡•ã‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç‡•§", aptPrefix:"‡§Ö‡§™‡§æ‡§∞‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü",
      apiChecking:"API: ‡§ú‡§æ‡§Å‡§ö ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à‚Ä¶", apiOk:"API: OK", apiNotReady:"API: ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§®‡§π‡•Ä‡§Ç", apiOffline:"API: ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§®",
      micReady:"‡§Æ‡§æ‡§á‡§ï: ‡§§‡•à‡§Ø‡§æ‡§∞", micUnsupported:"‡§Æ‡§æ‡§á‡§ï: ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§π‡•Ä‡§Ç", micNeedsHttps:"‡§Æ‡§æ‡§á‡§ï: HTTPS ‡§ö‡§æ‡§π‡§ø‡§è", micRecording:"‡§Æ‡§æ‡§á‡§ï: ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó‚Ä¶", micTranscribing:"‡§Æ‡§æ‡§á‡§ï: ‡§≤‡§ø‡§ñ ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶", micError:"‡§Æ‡§æ‡§á‡§ï: ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø",
      placeholder:"‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§≤‡§ø‡§ñ‡•á‡§Ç ‡§Ø‡§æ ‡§¨‡•ã‡§≤‡•á‡§Ç‚Ä¶", send:"‡§≠‡•á‡§ú‡•á‡§Ç",
      tip:"‡§ü‡§ø‡§™: üéôÔ∏è ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡§∞‡•á‡§Ç; ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§¶‡§¨‡§æ‡§ï‡§∞ ‡§∞‡•ã‡§ï‡•á‡§Ç ‡§î‡§∞ ‡§≠‡•á‡§ú‡•á‡§Ç‡•§ ‡§Ü‡§™ ‡§ö‡•Å‡§®‡•Ä ‡§π‡•Å‡§à ‡§≠‡§æ‡§∑‡§æ ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ/‡§¨‡•ã‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§ú‡§µ‡§æ‡§¨ ‡§ú‡§º‡•ã‡§∞ ‡§∏‡•á ‡§™‡§¢‡§º‡•á ‡§ú‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§",
      greet:"‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Ö‡§™‡§®‡•á ‡§†‡§π‡§∞‡§®‡•á ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç ‚Äî Wi-Fi, ‡§ö‡•á‡§ï-‡§á‡§®/‡§Ü‡§â‡§ü, ‡§®‡§ø‡§Ø‡§Æ ‡§î‡§∞ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡•Å‡§ù‡§æ‡§µ‡•§",
      missingApt:"‡§á‡§∏ ‡§™‡•á‡§ú ‡§ï‡•ã ‡§Ö‡§™‡§æ‡§∞‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•ã‡§° ‡§ö‡§æ‡§π‡§ø‡§è‡•§ ‡§â‡§¶‡§æ‡§π‡§∞‡§£: ?apt=YAKA01",
      missingAptLong:"‡§á‡§∏ ‡§≤‡§ø‡§Ç‡§ï ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§æ‡§∞‡•ç‡§ü‡§Æ‡•á‡§Ç‡§ü ‡§ï‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ QR ‡§∏‡•ç‡§ï‡•à‡§® ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ?apt=YAKA01 ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ñ‡•ã‡§≤‡•á‡§Ç‡•§",
      speak:"üîä ‡§¨‡•ã‡§≤‡•á‡§Ç", stop:"‚èπ ‡§∞‡•ã‡§ï‡•á‡§Ç", generating:"‡§¨‡§® ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶", ttsFail:"‡§Ü‡§µ‡§æ‡§ú‡§º ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§≤ ‡§™‡§æ‡§à‡•§",
      recNotSupported:"‡§á‡§∏ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§Æ‡•á‡§Ç ‡§µ‡•â‡§Ø‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡§ø‡§Ç‡§ó ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§",
      httpsRequired:"‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§™‡§∞ ‡§Æ‡§æ‡§á‡§ï‡•ç‡§∞‡•ã‡§´‡§º‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è HTTPS ‡§ö‡§æ‡§π‡§ø‡§è‡•§ HTTPS URL ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç‡•§",
      sttFail:"‡§µ‡•â‡§á‡§∏-‡§ü‡•Ç-‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü ‡§µ‡§ø‡§´‡§≤‡•§ ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§ï‡•ã‡§∂‡§ø‡§∂ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§",
      langUpdated:"‡§≠‡§æ‡§∑‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à‡•§ ‡§Ö‡§¨ ‡§Ü‡§™ ‡§á‡§∏ ‡§≠‡§æ‡§∑‡§æ ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§ñ ‡§Ø‡§æ ‡§¨‡•ã‡§≤ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§"
    },

    pt: { langLabel:"Idioma", tag:"Assistente do H√≥spede", sub:"Pergunte sobre Wi-Fi, check-in/out, regras da casa e locais pr√≥ximos.", aptPrefix:"Apartamento",
      apiChecking:"API: a verificar‚Ä¶", apiOk:"API: OK", apiNotReady:"API: n√£o pronta", apiOffline:"API: offline",
      micReady:"Mic: pronto", micUnsupported:"Mic: n√£o suportado", micNeedsHttps:"Mic: precisa de HTTPS", micRecording:"Mic: a gravar‚Ä¶", micTranscribing:"Mic: a transcrever‚Ä¶", micError:"Mic: erro",
      placeholder:"Escreva ou fale a sua pergunta‚Ä¶", send:"Enviar",
      tip:"Dica: toque üéôÔ∏è para gravar; toque novamente para parar e enviar. Pode escrever ou falar no idioma selecionado. As respostas podem ser lidas em voz alta.",
      greet:"Ol√°! Pergunte qualquer coisa sobre a sua estadia ‚Äî Wi-Fi, check-in/out, regras e dicas locais.",
      missingApt:"Esta p√°gina precisa de um c√≥digo de apartamento. Exemplo: ?apt=YAKA01",
      missingAptLong:"Este link n√£o tem c√≥digo de apartamento. Leia o QR do apartamento ou abra com ?apt=YAKA01.",
      speak:"üîä Falar", stop:"‚èπ Parar", generating:"A gerar‚Ä¶", ttsFail:"N√£o foi poss√≠vel reproduzir a voz.",
      recNotSupported:"A grava√ß√£o de voz n√£o √© suportada neste navegador. Escreva a sua pergunta.",
      httpsRequired:"O microfone precisa de HTTPS em telem√≥veis. Use o URL HTTPS.",
      sttFail:"Falha ao converter voz em texto. Tente novamente ou escreva.",
      langUpdated:"Idioma atualizado. Agora pode escrever ou falar neste idioma."
    },

    ar: { langLabel:"ÿßŸÑŸÑÿ∫ÿ©", tag:"ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∂ŸäŸàŸÅ", sub:"ÿßÿ≥ÿ£ŸÑ ÿπŸÜ ÿßŸÑŸàÿßŸä ŸÅÿßŸäÿå ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ/ÿßŸÑÿÆÿ±Ÿàÿ¨ÿå ŸÇŸàÿßÿπÿØ ÿßŸÑŸÖŸÜÿ≤ŸÑÿå ŸàÿßŸÑÿ£ŸÖÿßŸÉŸÜ ÿßŸÑŸÇÿ±Ÿäÿ®ÿ©.", aptPrefix:"ÿßŸÑÿ¥ŸÇÿ©",
      apiChecking:"API: ÿ¨ÿßÿ±Ÿç ÿßŸÑŸÅÿ≠ÿµ‚Ä¶", apiOk:"API: ŸäÿπŸÖŸÑ", apiNotReady:"API: ÿ∫Ÿäÿ± ÿ¨ÿßŸáÿ≤", apiOffline:"API: ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ",
      micReady:"ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ÿ¨ÿßŸáÿ≤", micUnsupported:"ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ", micNeedsHttps:"ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: Ÿäÿ≠ÿ™ÿßÿ¨ HTTPS", micRecording:"ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ÿ™ÿ≥ÿ¨ŸäŸÑ‚Ä¶", micTranscribing:"ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ ŸÜÿµ‚Ä¶", micError:"ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ÿÆÿ∑ÿ£",
      placeholder:"ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ÿ£Ÿà ÿ™ÿ≠ÿØÿ´‚Ä¶", send:"ÿ•ÿ±ÿ≥ÿßŸÑ",
      tip:"ŸÜÿµŸäÿ≠ÿ©: ÿßÿ∂ÿ∫ÿ∑ üéôÔ∏è ŸÑŸÑÿ™ÿ≥ÿ¨ŸäŸÑÿõ ÿßÿ∂ÿ∫ÿ∑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑŸÑÿ•ŸäŸÇÿßŸÅ ŸàÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ. ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ£Ÿà ÿßŸÑÿ™ÿ≠ÿØÿ´ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©. ŸäŸÖŸÉŸÜ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑÿ±ÿØŸàÿØ ÿ®ÿµŸàÿ™ ÿπÿßŸÑŸç.",
      greet:"ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿßÿ≥ÿ£ŸÑ ÿ£Ÿä ÿ¥Ÿäÿ° ÿπŸÜ ÿ•ŸÇÿßŸÖÿ™ŸÉ ‚Äî ÿßŸÑŸàÿßŸä ŸÅÿßŸäÿå ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ/ÿßŸÑÿÆÿ±Ÿàÿ¨ÿå ÿßŸÑŸÇŸàÿßÿπÿØÿå ŸàŸÜÿµÿßÿ¶ÿ≠ ŸÖÿ≠ŸÑŸäÿ©.",
      missingApt:"Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ±ŸÖÿ≤ ÿßŸÑÿ¥ŸÇÿ©. ŸÖÿ´ÿßŸÑ: ?apt=YAKA01",
      missingAptLong:"Ÿáÿ∞ÿß ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸäŸÅÿ™ŸÇÿØ ÿ±ŸÖÿ≤ ÿßŸÑÿ¥ŸÇÿ©. ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÖÿ≥ÿ≠ ÿ±ŸÖÿ≤ QR ÿ£Ÿà ÿßŸÑŸÅÿ™ÿ≠ ŸÖÿπ ?apt=YAKA01.",
      speak:"üîä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™", stop:"‚èπ ÿ•ŸäŸÇÿßŸÅ", generating:"ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°‚Ä¶", ttsFail:"ÿ™ÿπÿ∞ÿ± ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™.",
      recNotSupported:"ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿµŸàÿ™Ÿä ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÉÿ™ÿßÿ®ÿ©.",
      httpsRequired:"ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ Ÿäÿ≠ÿ™ÿßÿ¨ HTTPS ÿπŸÑŸâ ÿßŸÑŸáŸàÿßÿ™ŸÅ. ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿ±ÿßÿ®ÿ∑ HTTPS.",
      sttFail:"ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿ•ŸÑŸâ ŸÜÿµ. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ£Ÿà ÿßŸÉÿ™ÿ®.",
      langUpdated:"ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÑÿ∫ÿ©. ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ¢ŸÜ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ£Ÿà ÿßŸÑÿ™ÿ≠ÿØÿ´ ÿ®Ÿáÿ∞Ÿá ÿßŸÑŸÑÿ∫ÿ©."
    }
  };

  function guessBrowserLang() {
    const b = (navigator.language || 'en').toLowerCase();
    if (b.startsWith('si')) return 'si';
    if (b.startsWith('ta')) return 'ta';
    if (b.startsWith('es')) return 'es';
    if (b.startsWith('ru')) return 'ru';
    if (b.startsWith('it')) return 'it';
    if (b.startsWith('zh')) return 'zh';
    if (b.startsWith('de')) return 'de';
    if (b.startsWith('pl')) return 'pl';
    if (b.startsWith('fr')) return 'fr';
    if (b.startsWith('hi')) return 'hi';
    if (b.startsWith('pt')) return 'pt';
    if (b.startsWith('ar')) return 'ar';
    return 'en';
  }

  function getUiLang() {
    const saved = localStorage.getItem('yaka_ui_lang');
    if (saved && I18N[saved]) return saved;
    return guessBrowserLang();
  }

  let uiLang = getUiLang();
  langSelect.value = uiLang;

  function t(key) {
    return (I18N[uiLang] && I18N[uiLang][key]) ? I18N[uiLang][key] : (I18N.en[key] || key);
  }

  function applyLanguageToUi() {
    document.documentElement.lang = uiLang;

    // RTL support for Arabic
    document.documentElement.dir = (uiLang === 'ar') ? 'rtl' : 'ltr';

    langLabel.textContent = t('langLabel');
    tagText.textContent = t('tag');
    subText.textContent = t('sub');
    msgEl.placeholder = t('placeholder');
    sendBtn.textContent = t('send');
    hintText.textContent = t('tip');

    aptPill.textContent = apt ? `${t('aptPrefix')}: ${apt}` : `${t('aptPrefix')}: (not set)`;
  }

  langSelect.addEventListener('change', () => {
    uiLang = langSelect.value;
    localStorage.setItem('yaka_ui_lang', uiLang);
    applyLanguageToUi();

    addBubble(t('langUpdated'), 'bot', '', { speak: true });
  });

  // Cache TTS audio by exact reply text
  const ttsCache = new Map(); // text -> blobUrl

  // Prevent overlapping TTS
  let currentTtsAudio = null;
  let currentTtsAbort = null;

  function stopTtsPlayback() {
    if (currentTtsAudio) {
      try { currentTtsAudio.pause(); } catch {}
      try { currentTtsAudio.currentTime = 0; } catch {}
      currentTtsAudio = null;
    }
    if (currentTtsAbort) {
      try { currentTtsAbort.abort(); } catch {}
      currentTtsAbort = null;
    }
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function linkify(text) {
    const safe = escapeHtml(text);
    const withLinks = safe.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
    return withLinks.replace(/\n/g, '<br>');
  }

  function setMicStatus(textKey) {
    micPill.textContent = t(textKey);
  }

  function setApiStatus(textKey) {
    apiPill.textContent = t(textKey);
  }

  function addBubble(text, who = 'bot', meta = '', options = {}) {
    const div = document.createElement('div');
    div.className = `bubble ${who}`;

    const content = document.createElement('div');
    if (who === 'bot') {
      content.innerHTML = linkify(text);
    } else {
      content.textContent = text;
    }
    div.appendChild(content);

    // Speak (TTS) button on bot messages
    if (who === 'bot' && options.speak === true) {
      const row = document.createElement('div');
      row.style.marginTop = '10px';

      const speakBtn = document.createElement('button');
      speakBtn.className = 'btn secondary small-btn';
      speakBtn.type = 'button';
      speakBtn.textContent = t('speak');

      const stopBtn = document.createElement('button');
      stopBtn.className = 'btn secondary small-btn';
      stopBtn.type = 'button';
      stopBtn.textContent = t('stop');
      stopBtn.onclick = () => stopTtsPlayback();

      speakBtn.onclick = async () => {
        const oldLabel = speakBtn.textContent;

        stopTtsPlayback();

        speakBtn.disabled = true;
        speakBtn.textContent = t('generating');

        try {
          if (ttsCache.has(text)) {
            currentTtsAudio = new Audio(ttsCache.get(text));
            currentTtsAudio.onended = () => { currentTtsAudio = null; };
            await currentTtsAudio.play();
            return;
          }

          currentTtsAbort = new AbortController();

          const r = await fetch('/api/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: currentTtsAbort.signal,
            body: JSON.stringify({ text })
          });

          if (!r.ok) throw new Error(await r.text());

          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          ttsCache.set(text, url);

          currentTtsAudio = new Audio(url);
          currentTtsAudio.onended = () => { currentTtsAudio = null; };
          await currentTtsAudio.play();
        } catch (e) {
          if (e?.name !== 'AbortError') {
            alert(t('ttsFail') + " " + (e.message || e));
          }
        } finally {
          currentTtsAbort = null;
          speakBtn.disabled = false;
          speakBtn.textContent = oldLabel;
        }
      };

      row.appendChild(speakBtn);
      row.appendChild(stopBtn);
      div.appendChild(row);
    }

    if (meta) {
      const m = document.createElement('div');
      m.className = 'meta';
      m.textContent = meta;
      div.appendChild(m);
    }

    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  async function pingApi() {
    try {
      const res = await fetch('/', { method: 'GET' });
      setApiStatus(res.ok ? 'apiOk' : 'apiNotReady');
    } catch (e) {
      setApiStatus('apiOffline');
    }
  }

  async function sendMessage(text) {
    const message = (text ?? msgEl.value).trim();
    if (!message) return;

    if (!apt) {
      addBubble(t('missingAptLong'), 'bot', '', { speak: true });
      return;
    }

    if (!text) msgEl.value = '';
    addBubble(message, 'me');

    sendBtn.disabled = true;
    micBtn.disabled = true;

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apt, message })
      });

      if (!res.ok) {
        const tt = await res.text();
        addBubble('Sorry ‚Äî something went wrong contacting the server.', 'bot', `HTTP ${res.status}: ${tt.slice(0, 160)}`, { speak: true });
        return;
      }

      const data = await res.json();
      const reply = data.reply || 'No reply returned.';
      const meta = [
        data.source ? `source=${data.source}` : null,
        (typeof data.score === 'number') ? `score=${data.score.toFixed(2)}` : null,
        data.detected_language ? `lang=${data.detected_language}` : null
      ].filter(Boolean).join(' ‚Ä¢ ');

      addBubble(reply, 'bot', meta, { speak: true });
    } catch (e) {
      addBubble('Sorry ‚Äî could not reach the server. Is it running?', 'bot', e.message || String(e), { speak: true });
    } finally {
      sendBtn.disabled = false;
      micBtn.disabled = false;
      msgEl.focus();
    }
  }

  sendBtn.addEventListener('click', () => sendMessage());
  msgEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // -----------------------
  // MediaRecorder Voice STT
  // -----------------------
  let mediaRecorder = null;
  let chunks = [];
  let isRecording = false;
  let activeMimeType = '';

  function getBestRecorderMimeType() {
    const candidates = [
      'audio/webm;codecs=opus',
      'audio/webm',
      'audio/mp4',
      'audio/mpeg'
    ];
    if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) return '';
    for (const t0 of candidates) {
      try { if (MediaRecorder.isTypeSupported(t0)) return t0; } catch {}
    }
    return '';
  }

  function extensionForMime(mime) {
    const m = (mime || '').toLowerCase();
    if (m.includes('mp4')) return 'mp4';
    if (m.includes('mpeg')) return 'mp3';
    return 'webm';
  }

  async function startRecording() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setMicStatus('micUnsupported');
      addBubble(t('recNotSupported'), 'bot', '', { speak: true });
      return;
    }

    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      setMicStatus('micNeedsHttps');
      addBubble(t('httpsRequired'), 'bot', '', { speak: true });
      return;
    }

    if (!window.MediaRecorder) {
      setMicStatus('micUnsupported');
      addBubble(t('recNotSupported'), 'bot', '', { speak: true });
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    chunks = [];

    activeMimeType = getBestRecorderMimeType();
    try {
      mediaRecorder = activeMimeType
        ? new MediaRecorder(stream, { mimeType: activeMimeType })
        : new MediaRecorder(stream);
    } catch (e) {
      mediaRecorder = new MediaRecorder(stream);
      activeMimeType = mediaRecorder.mimeType || '';
    }

    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) chunks.push(e.data);
    };

    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(tk => tk.stop());

      setMicStatus('micTranscribing');

      try {
        const mime = mediaRecorder.mimeType || activeMimeType || 'audio/webm';
        const ext = extensionForMime(mime);

        const blob = new Blob(chunks, { type: mime });
        const fd = new FormData();
        fd.append('audio', blob, `audio.${ext}`);

        const r = await fetch('/api/stt', { method: 'POST', body: fd });
        if (!r.ok) {
          const errText = await r.text();
          throw new Error(errText || `HTTP ${r.status}`);
        }

        const data = await r.json();
        const text = (data.text || '').trim();

        if (!text) {
          addBubble("Sorry ‚Äî I couldn't hear that. Please try again.", 'bot', '', { speak: true });
          setMicStatus('micReady');
          return;
        }

        setMicStatus('micReady');
        await sendMessage(text);
      } catch (e) {
        setMicStatus('micError');
        addBubble(t('sttFail'), 'bot', e.message || String(e), { speak: true });
        setMicStatus('micReady');
      }
    };

    mediaRecorder.start();
    setMicStatus('micRecording');
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
  }

  micBtn.addEventListener('click', async () => {
    try {
      if (!isRecording) {
        isRecording = true;
        micBtn.textContent = '‚èπÔ∏è';
        await startRecording();
      } else {
        isRecording = false;
        micBtn.textContent = 'üéôÔ∏è';
        stopRecording();
      }
    } catch (e) {
      isRecording = false;
      micBtn.textContent = 'üéôÔ∏è';
      setMicStatus('micError');
      addBubble('Could not start recording.', 'bot', e.message || String(e), { speak: true });
      setMicStatus('micReady');
    }
  });

  // Apply language to UI first
  applyLanguageToUi();

  // Initial UX bubbles
  addBubble(t('greet'), 'bot', '', { speak: true });
  if (!apt) addBubble(t('missingApt'), 'bot', '', { speak: true });

  setMicStatus('micReady');
  setApiStatus('apiChecking');
  pingApi();
  msgEl.focus();
</script>

</body>
</html>
